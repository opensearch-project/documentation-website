---
layout: default
title: OTel APM Service map
parent: Processors
grand_parent: Pipelines
nav_order: 245
---

# OTEL APM Service map processor

The `otel_apm_service_map` processor analyzes OpenTelemetry trace spans to automatically generate Application Performance Monitoring (APM) service map relationships and metrics. It creates structured events that can be visualized as service topology graphs, showing how services communicate with each other and their performance characteristics.

The `otel_apm_service_map` processor provides all the functionality of the existing service-map processor while offering enhanced capabilities for observability. In addition to generating service maps, this processor creates time-based service maps that capture the evolving relationships between services over time, rather than producing a static, fixed representation. The processor also automatically generates RED metrics (Rate, Errors, and Duration) for each service, providing immediate insights into service health and performance without requiring additional configuration.


## Configuration

The following table describes the option you can use to configure the `otel_apm_service_map` processor.

<!--
This table is autogenerated. Do not edit it.
- name: otel_apm_service_map
- pluginType: processor
- source: https://github.com/opensearch-project/data-prepper/blob/6eb06fe60c21bc4125875af5a3052e332908a12a/data-prepper-plugins/otel-apm-service-map-processor/src/main/java/org/opensearch/dataprepper/plugins/processor/otel_apm_service_map/OTelApmServiceMapProcessorConfig.java
-->

Option | Required | Type | Description
:--- | :--- | :--- | :---
window_duration | No | Duration | Represents the fixed time window during which APM service map relationships are evaluated. Supports ISO-8601 duration format (e.g., PT60S, PT1M) or simple integer values (interpreted as seconds).  Default value is 60s.
db_path | No | String | Represents folder path for creating database files storing transient data of heap memory when processing APM service map data. Default value is data/otel-apm-service-map/.
group_by_attributes | No | List | List of OTEL resource attribute names that should be copied into Service.groupByAttributes when present on the span's resource attributes. Only applied to primary Service objects, not dependency services. Default is empty list.

## Configuration

```
entry-pipeline:
   source:
     otel_trace_source:
       path: "/test/path"
   sink:
     - pipeline:
         name: "raw-pipeline"
     - pipeline:
         name: "service-map-pipeline"
raw-pipeline:
   source:
     pipeline:
       name: "entry-pipeline"
   processor:
     - otel_trace_raw:
   sink:
     - opensearch:
         hosts: [<host>]
         index_type: trace-analytics-raw
service-map-pipeline:
   source:
     pipeline:
       name: "entry-pipeline"
   processor:
     - otel_apm_service_map:
         window_duration: 60s
         db_path: "data/otel-apm-service-map/"
   sink:
     - opensearch:
         hosts: [<host>]
         index_type: trace-analytics-service-map
```


## Metrics

The following table describes common [Abstract processor](https://github.com/opensearch-project/data-prepper/blob/main/data-prepper-api/src/main/java/org/opensearch/dataprepper/model/processor/AbstractProcessor.java) metrics.

| Metric name | Type | Description |
| ------------- | ---- | -----------|
| `recordsIn` | Counter | Metric representing the ingress of records to a pipeline component. |
| `recordsOut` | Counter | Metric representing the egress of records from a pipeline component. |
| `timeElapsed` | Timer | Metric representing the time elapsed during execution of a pipeline component. |

The `otel_apm_service_map` processor includes following custom metrics:

* `spansDbSize`:  Total size in bytes of all three span database windows
* `spansDbCount`: Total count of span entries across all three span database windows

